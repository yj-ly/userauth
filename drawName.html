<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>绘制签名</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/public.css">
    <link rel="stylesheet" href="./css/drawName.css">
    <script src="./js/lib-flexible.js"></script>
    <script src="./js/jquery-2.1.1.js"></script>
    <script src="./js/signature_pad.min.js"></script>
    <script src="./js/vue.js"></script>
<!--    <script src="./js/jquery.ui.touch-punch.min.js"></script>-->
<!--    <script src="./js/axios.js"></script>-->
</head>
<body>

<div class="draw_con">
    <header><a href="javascript:history.back(-1)" class="back"></a>请绘制清晰可辩的签名</header>
    <div class="main">

        <canvas id="canvas"></canvas>

    </div>

    <div class="select_model" id="select_model">
                    <div class="font_con">
                        <span class="pen_size ac" data-size="1">
                            <i></i>
                        </span>
                        <span class="pen_size" data-size="2.5">
                            <i></i>
                        </span>
                        <span class="pen_size" data-size="4.5">
                            <i></i>
                        </span>
                    </div>

                    <div class="color_con">
                        <span class="color ac" data-color="#000000">
                            <i></i>
                        </span>
                        <span class="color" data-color="rgba(69,164,227,1)">
                            <i></i>
                        </span>
                        <span class="color" data-color="rgba(231,73,88,1)">
                            <i></i>
                        </span>
                    </div>


    </div>

    <div class="bottom_local">
        <button id="clear">清除</button>
        <button id="save">保存</button>
    </div>

    <div class="hind_con">
        <div class="model" v-if="hindMsg"></div>
        <div class="model_con" :class="{'show_model':showModel}">{{hindMsg}}</div>
    </div>
</div>

</body>
</html>
<script type="text/javascript">

    var vm = new Vue({
        el:'.draw_con',
        data:{
            hindMsg:'',  //提示信息
            showModel:false, //展示提醒弹框
        },
        methods:{
            /** 16:11
             *   @author: yuanjie
             *   @description:关闭错误信息弹框
             *   @param
             */
            closeModel() {
                setTimeout(() => {
                    this.hindMsg = '';
                    this.showModel = false;
                }, 3000)
            }
        }
    })

    var penSize = 1;   //笔的大小
    var penColor = '#000000';   //画笔的颜色
    var token = '';

    hasUrlToken(window.location.href);
    /** 15:49
     *   @author: yuanjie
     *   @description:判断用户有没有token
     *   @param{string} 当前浏览器的url
     */
    function  hasUrlToken(url) {
        if (url == '') {
            throw 'url参数不能为空';
        }
        let indexNum = url.indexOf('?');
        if (indexNum < 0) {
            // throw '当前url参数格式有问题';
        }
        let obj = {};
        let urlStr = url.substr(indexNum + 1, url.length);
        let strList = urlStr.split('&');
        for (let i = 0; i < strList.length; i++) {
            let itemIndex = strList[i].indexOf('=');
            let name = strList[i].substr(0, itemIndex);
            let val = strList[i].substr(itemIndex + 1, strList[i].length);
            obj[name] = val;
        }

        if (toString(obj) == '{}') {
            console.log('没有参数');
        } else {
            token = obj.token;
        }

    }

    function changeSize(){
        var canvasHeight = document.documentElement.clientHeight - $('header').eq(0).outerHeight() - $('.bottom_local').eq(0).outerHeight() - $('#select_model').outerHeight();
        $("#canvas").attr({"height":canvasHeight,"width":window.innerWidth});
        var canvasX = $("#canvas")[0];
        signaturePad = new SignaturePad(canvasX,{
            dotSize : 0 ,
            velocityFilterWeight :1,
            minWidth: penSize,
            maxWidth: 5.2,
            penColor: penColor,
            backgroundColor:"rgba(0,0,0,0)"
        });
    }

    function isWeiXin(){
        var ua = window.navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i) == 'micromessenger'){
            return true;
        }else{
            return false;
        }
    }

    function CloseWebPage(){
        if (navigator.userAgent.indexOf("MSIE") > 0) {
            if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {
                window.opener = null;
                window.close();
            } else {
                window.open('', '_top');
                window.top.close();
            }
        }
        else if (navigator.userAgent.indexOf("Firefox") > 0) {
            window.location.href = 'about:blank ';
        }else {
            window.opener = null;
            window.open('', '_self', '');
            window.close();
        }
    }
        changeSize();
        $(window).resize(function(){
            changeSize();
        });
        $('#clear').click(function() {
            signaturePad.clear();
        });



        $('.pen_size').click(function () {
            var canvasX = $("#canvas")[0];
            penSize = $(this).attr('data-size');
            signaturePad = new SignaturePad(canvasX,{
                dotSize : 0 ,
                velocityFilterWeight :1,
                minWidth: penSize,
                maxWidth: 5.2,
                penColor:penColor,
                backgroundColor:"rgb(255,255,255)"
            });
            $('.pen_size').removeClass("ac");
            $(this).addClass("ac");
        })


        $('.color').click(function() {
            var canvasX = $("#canvas")[0];
            penColor = $(this).attr('data-color');
            signaturePad = new SignaturePad(canvasX,{
                dotSize : 0 ,
                velocityFilterWeight :1,
                minWidth: penSize,
                maxWidth: 5.2,
                penColor:penColor,
                backgroundColor:"rgb(255,255,255)"
            });
            $('.color').removeClass("ac");
            $(this).addClass("ac");
        });
        $('#save').click(function() {
            if(signaturePad.isEmpty()){
                vm.hindMsg = '绘画名字为空';
                vm.showModel = true;
                vm.closeModel();

            }else{
                var canvas = document.getElementById("canvas");
                //获取图片的Base64，包含头信息data:image/png;base64,
                var canvasData = canvas.toDataURL("image/png");
                /* canvasData = encodeURIComponent(encodeURIComponent(canvasData));    */
                //alert(canvasData);
                //去掉图片Base64中的头信息data:image/png;base64,直接可作为sealData使用
                var image_base64= canvasData.split(",")[1];
                //alert(image_base64);
                console.log(canvasData);
                sessionStorage.setItem('userDrawName',canvasData);
                sessionStorage.setItem('resetImsgUrl',image_base64)

                vm.hindMsg = '保存成功';
                vm.showModel = true;
                vm.closeModel();
                window.location.href = './protocol.html?api_token='+token;
            }
        });

        $("#close").click(function(){
            if(isWeiXin()){
                WeixinJSBridge.call('closeWindow');
            }else{
                CloseWebPage();
            }
        });

</script>

