<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>银行卡认证</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/public.css">
    <link rel="stylesheet" href="./css/userMsg.css">
    <script src="./js/lib-flexible.js"></script>
    <script src="./js/axios.js"></script>
    <script src="./js/vue.js"></script>
</head>
<body>
<div class="msg_con">

    <header>银行卡认证</header>

    <div class="main">

        <!--        顶部状态-->
        <div class="status_con">
            <div class="status_c">
                <div class="status_item">
                    <div class="ac_radius">1</div>
                    <p>银行卡</p>
                </div>
                <div class="status_item">
                    <div>2</div>
                    <p>人脸核验</p>
                </div>
                <div class="status_item">
                    <div>3</div>
                    <p>签约协议</p>
                </div>
            </div>

        </div>

        <div class="user_msg">
            <div class="msg_item">
                <span>真实姓名</span>
                <input type="text" placeholder="请输入真实姓名" maxlength="5" v-model="msgModel.realname">
            </div>
            <div class="msg_item">
                <span>证件号码</span>
                <input type="text" placeholder="请输入身份证号" maxlength="20" v-model="msgModel.idcard">
            </div>
            <div class="msg_item">
                <span>银行卡号</span>
                <input type="text" placeholder="请输入银行卡号" maxlength="20" v-model="msgModel.bank_card">
            </div>
            <div class="msg_item">
                <span>银行预留手机号</span>
                <input type="text" placeholder="请输入银行预留手机号" maxlength="11" v-model="msgModel.phone">
            </div>
        </div>

        <!--        认证按钮-->
        <div class="btn_con">
            <button class="btn" @click="submitMsg" :class="{'after_btn':!btnBoole}">{{btnMsg}}</button>
        </div>
    </div>

<!--    提示信息-->
    <div class="hind_con">
        <div class="model" v-if="showModel"></div>
        <div class="model_con" :class="{'show_model':showModel}">{{hindMsg}}</div>
    </div>

<!--   用户输入手机号 -->
    <div class="code_con">
        <div class="model" v-if="showAuthModel">
        </div>

        <div class="model_con" v-if="showAuthModel">
            <div class="top">
                <span>请输入验证码</span>
                <input type="text" v-model="codeAuth.code">
            </div>
            <p class="hind_msg" v-if="errorMsg">{{errorMsg}}</p>
            <div class="button_con">
                <button @click="cacelAuth">取消</button>
                <button @click="submitCode">{{btnMsg2}}</button>
            </div>

        </div>
    </div>

</div>

</body>
</html>

<script>
    new Vue({
        el: '.msg_con',
        data: {
            msgModel: {
                phone: '',
                api_token: '',
                realname: '',
                idcard: '',
                bank_card: ''
            },
            btnMsg: '申请认证',
            hindMsg: '',   //提示信息
            showModel: false,
            btnBoole: true,

            showAuthModel:false,  //展示认证短信弹框
            codeAuth:{
                code:'',
                api_token:'',
            },
            btnMsg2:'确认',
            errorMsg:''

        },

        mounted() {
            this.hasUrlToken(window.location.href);
        },

        methods: {

            /** 15:49
             *   @author: yuanjie
             *   @description:判断用户有没有token
             *   @param{string} 当前浏览器的url
             */
            hasUrlToken(url) {
                if (url == '') {
                    throw 'url参数不能为空';
                }
                let indexNum = url.indexOf('?');
                if (indexNum < 0) {
                    throw '当前url参数格式有问题';
                }
                let obj = {};
                let urlStr = url.substr(indexNum + 1, url.length);
                let strList = urlStr.split('&');
                for (let i = 0; i < strList.length; i++) {
                    let itemIndex = strList[i].indexOf('=');
                    let name = strList[i].substr(0, itemIndex);
                    let val = strList[i].substr(itemIndex + 1, strList[i].length);
                    obj[name] = val;
                }

                if (toString(obj) == '{}') {
                    console.log('没有参数');
                } else {

                    this.msgModel.api_token = obj.api_token;
                    this.codeAuth.api_token = obj.api_token;
                }

            },


            /** 13:57
             *   @author: yuanjie
             *   @description:提交用户信息
             *   @param
             */
            submitMsg() {
                if (this.msgModel.realname == '') {
                    this.hindMsg = '请填写姓名';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                if (this.msgModel.idcard == '') {
                    this.hindMsg = '请填写身份证号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                if (!this.isCardNo(this.msgModel.idcard)) {
                    this.hindMsg = '请填写正确格式的身份证号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                if (this.msgModel.bank_card.length == '') {
                    this.hindMsg = '请填写银行卡号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }


                if (!(this.msgModel.bank_card.length >= 16 && this.msgModel.bank_card.length <= 19)) {
                    this.hindMsg = '请填写正确格式的银行卡号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                if (this.msgModel.phone == '') {
                    this.hindMsg = '请填写银行预留手机号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                if (!this.judgeUserPhone(this.msgModel.phone)) {
                    this.hindMsg = '请填正确格式的手机号';
                    this.showModel = true;
                    this.closeModel();
                    return false;
                }

                this.btnMsg = '资料上传中';
                this.btnBoole = false;
                axios.post('/api/common/eqb/fourAuth', this.msgModel).then((res) => {
                    if (res.data.status) {
                        this.queryUserAuth();  //查询用户上传资料状态
                    } else {
                        this.hindMsg = res.data.msg;
                        this.showModel = true;
                        this.btnMsg = '申请认证';
                        this.closeModel();
                        this.btnBoole = true;
                    }
                })
            },

            /** 9:49
              *   @author: yuanjie
              *   @description:取消用户短信弹框
              *   @param
              */
            cacelAuth() {
                this.showAuthModel = false;
                this.hindMsg = '';
            },

            /** 10:02
              *   @author: yuanjie
              *   @description:提交验证码
              *   @param
              */
            submitCode() {
                if(this.codeAuth.code == '') {
                    this.errorMsg = '请输入验证码';
                    return false;
                }
                this.errorMsg = '';
                this.btnMsg2 = '加载中';
                if(this.btnBoole) {
                    this.btnBoole = false;
                    axios.post('/api/common/eqb/getinfo', this.codeAuth).then((res) => {
                        if(res.data.status == true) {
                            this.showAuthModel = false;
                            this.btnMsg2 = '确认';
                            this.hindMsg = '即将开始人脸核验';
                            this.showModel = true;
                            this.closeModel();

                            setTimeout(() => {
                                window.location.href = `./faceAuth.html?token=${this.msgModel.api_token}`;
                            }, 2000)
                        }else {
                            this.btnMsg2 = '确认';
                            this.errorMsg = res.data.msg;
                        }
                        this.btnBoole = true;
                    })
                }


            },





            /** 16:36
             *   @author: yuanjie
             *   @description:查询用户上传资料状态
             *   @param
             */
            queryUserAuth() {
                axios.post('/api/common/eqb/getinfo', this.msgModel).then((res) => {
                    if (res.data.status) {
                        // this.hindMsg = '资料上传成功';
                        // this.showModel = true;
                        // this.closeModel();
                        this.btnMsg = '申请认证';
                        this.btnBoole = true;
                        this.showAuthModel = true;
                    } else {
                        this.hindMsg = res.data.msg;
                        this.btnMsg = '申请认证';
                        this.closeModel();
                        this.btnBoole = true;
                    }
                })
            },
            /** 13:10
             *   @author: yuanjie
             *   @description:验证身份证号
             *   @param
             */
            isCardNo(card) {
                // 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X
                var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
                if (reg.test(card) == false) {
                    return false;
                } else {
                    return true;
                }
            },

            /** 14:05
             *   @author: yuanjie
             *   @description:判断手机号码是否法
             *   @param
             */
            judgeUserPhone(phone) {
                if (phone == '' || phone == undefined) {
                    return false;
                }
                let phoneReg = /(^1[3|4|5|7|8|9]\d{9}$)|(^09\d{8}$)/;
                if (!phoneReg.test(phone)) {
                    return false;
                } else {
                    return true;
                }
            },

            /** 16:11
             *   @author: yuanjie
             *   @description:关闭错误信息弹框
             *   @param
             */
            closeModel() {
                setTimeout(() => {
                    this.hindMsg = '';
                    this.showModel = false;
                }, 3000)
            }
        }
    })
</script>